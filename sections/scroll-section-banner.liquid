<div id="{{ section.id }}" class="shopify-section">
  {%- liquid
    assign st = section.settings
    assign has_overlay = true
    assign overlay_opacity = 0.3
  -%}

  <div class="sec_cov" style="--sbg:{{ st.bg }};--sst:{{ st.sst }}px;--ssb:{{ st.ssb }}px;--sstm:{{ st.sstm }}px;--ssbm:{{ st.ssbm }}px;">
    <div class="{% if st.sw %}fw-sec{% if st.npd %} npd{% endif %}{% else %}page-width{% endif %} section-wrapper" style="--cl:{{ st.cl }};--fs:{{ st.fs }}px;--fsm:{{ st.fsm }}px;--fw:{{ st.fw }};--bcl:{{ st.bcl }};--fbg:{{ st.fbg }};--bd:{{ st.bd }};">
      
      <div class="banner {{ st.media_height }} mobile:{{ st.media_height }}">
        
        {%- if has_overlay -%}
          <span class="banner__overlay"></span>
        {%- endif -%}
        
        <div class="scrolled-images" data-parallax="{{ st.parallax_speed | default: 1.5 }}">
          <div class="scrolled-images__main">
            {%- liquid
              assign images = ''
              
              if st.image_1 != blank
                assign img_url = st.image_1 | image_url: width: 1200
                assign images = images | append: img_url | append: ','
              endif
              
              if st.image_2 != blank
                assign img_url = st.image_2 | image_url: width: 1200
                assign images = images | append: img_url | append: ','
              endif
              
              if st.image_3 != blank
                assign img_url = st.image_3 | image_url: width: 1200
                assign images = images | append: img_url | append: ','
              endif
              
              if st.image_4 != blank
                assign img_url = st.image_4 | image_url: width: 1200
                assign images = images | append: img_url | append: ','
              endif
              
              if st.image_5 != blank
                assign img_url = st.image_5 | image_url: width: 1200
                assign images = images | append: img_url | append: ','
              endif
              
              assign image_array = images | remove_last: ',' | split: ','
              assign image_count = image_array.size
            -%}
            
            {%- if image_count > 0 -%}
              {%- for row in (0..2) -%}
                <div class="scrolled-images__row" data-row="{{ row }}">
                  {%- assign start_pos = row | modulo: image_count -%}
                  
                  {%- for repeat in (0..2) -%}
                    {%- for i in (0..image_count) -%}
                      {%- assign img_index = i | plus: start_pos | modulo: image_count -%}
                      {%- assign current_image = image_array[img_index] -%}
                      
                      {%- if current_image != blank -%}
                        <div class="scrolled-images__item" style="background-image: url({{ current_image }});"></div>
                      {%- endif -%}
                    {%- endfor -%}
                  {%- endfor -%}
                </div>
              {%- endfor -%}
            {%- endif -%}
          </div>
        </div>
        
        <div class="banner__content">
          <div class="banner__text">
            {%- if st.heading != blank -%}
              <h2 class="banner__heading">
                {{ st.heading }}
              </h2>
            {%- endif -%}
            
            {%- if st.subheading != blank -%}
              <div class="banner__subheading">
                {{ st.subheading }}
              </div>
            {%- endif -%}
            
            {%- if st.show_view_all != blank and st.collection != blank -%}
              <a href="/collections/{{ st.collection }}" class="banner__button">
                {{ st.show_view_all }}
              </a>
            {%- endif -%}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  #{{ section.id }} {
    --color-overlay: 23, 23, 23;
    --overlay-opacity: {{ overlay_opacity }};
  }

  /* Section spacing */
  .sec_cov {
    padding-top: var(--sst);
    padding-bottom: var(--ssb);
    background: var(--sbg);
  }

  @media screen and (max-width: 767px) {
    .sec_cov {
      padding-top: var(--sstm);
      padding-bottom: var(--ssbm);
    }
  }

  /* Section wrapper */
  .section-wrapper {
    position: relative;
    color: var(--cl);
    font-size: var(--fs);
    font-weight: var(--fw);
  }

  .page-width {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
  }

  .fw-sec {
    width: 100%;
  }

  .fw-sec.npd {
    padding-left: 0;
    padding-right: 0;
  }

  @media screen and (max-width: 767px) {
    .section-wrapper {
      font-size: var(--fsm);
    }
  }

  /* Banner */
  .banner {
    position: relative;
    overflow: hidden;
  }

  .media--400px { height: 400px; }
  .media--450px { height: 450px; }
  .media--500px { height: 500px; }
  .media--550px { height: 550px; }
  .media--600px { height: 600px; }
  .media--650px { height: 650px; }
  .media--700px { height: 700px; }
  .media--750px { height: 750px; }
  .media--800px { height: 800px; }
  .media--850px { height: 850px; }
  .media--900px { height: 900px; }

  @media screen and (max-width: 767px) {
    .banner.mobile\:media--400px { height: 400px; }
    .banner.mobile\:media--450px { height: 450px; }
    .banner.mobile\:media--500px { height: 500px; }
    .banner.mobile\:media--550px { height: 550px; }
    .banner.mobile\:media--600px { height: 600px; }
  }

  .banner__overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgb(var(--color-overlay) / var(--overlay-opacity));
    pointer-events: none;
    z-index: 1;
  }

  /* Scrolled Images */
  .scrolled-images {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    z-index: 0;
  }

  .scrolled-images__main {
    position: absolute;
    top: 50%; /* Center vertically */
    left: 50%; /* Center horizontally */
    transform: translate(-50%, -50%) rotate(25deg); /* Adjust rotation for a more dynamic look */
    /* Use a larger height for the tiles to fill more screen space when rotated */
    --tiles-size: 60vw; /* Base size for tiles */
    --tileswrap-width: calc(var(--tiles-size) * 2.5); /* Adjust width to fit rotated grid */
    --tileswrap-height: calc(var(--tiles-size) * 2.5); /* Adjust height to fit rotated grid */
    width: var(--tileswrap-width);
    height: var(--tileswrap-height);
    will-change: transform;
    display: flex; /* Use flexbox to arrange rows */
    flex-direction: column; /* Stack rows vertically */
    justify-content: center;
    align-items: center;
  }

  @media screen and (min-width: 768px) {
    .scrolled-images__main {
      /* Adjust for desktop if needed, maybe a slightly different rotation or size */
      transform: translate(-50%, -50%) rotate(20deg);
      --tiles-size: 40vw; /* Smaller base size for desktop */
      --tileswrap-width: calc(var(--tiles-size) * 2.5);
      --tileswrap-height: calc(var(--tiles-size) * 2.5);
    }
  }

  .scrolled-images__row {
    display: flex;
    white-space: nowrap; /* Keep items in a single line */
    will-change: transform;
    transition: transform 0.1s linear; /* Keep existing transition */
    padding: 1vw 0; /* Add some padding between rows */
  }

  /* Adjust opacity for subtle depth */
  .scrolled-images__row[data-row="0"] {
    opacity: 0.5; /* Slightly more visible */
  }

  .scrolled-images__row[data-row="1"] {
    opacity: 0.7; /* Main focus row */
  }

  .scrolled-images__row[data-row="2"] {
    opacity: 0.5; /* Slightly more visible */
  }

  .scrolled-images__item {
    --tile-margin: 0.8vw; /* Adjust margin between tiles */
    --tile-dimension: 20vw; /* Define a base dimension for the square tiles */
    width: var(--tile-dimension);
    height: var(--tile-dimension);
    margin: var(--tile-margin);
    background-position: center;
    background-size: cover;
    background-repeat: no-repeat;
    border-radius: 15px; /* Slightly less rounded for a sharper look */
    transform: rotate(0deg); /* Remove the individual item rotation for a cleaner grid */
    overflow: hidden; /* Ensure content inside item is clipped */
    position: relative;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3); /* Add a subtle shadow */
  }

  @media screen and (min-width: 768px) {
    .scrolled-images__item {
      --tile-dimension: 15vw; /* Adjust for desktop tile size */
      border-radius: 20px;
    }
  }

  /* Banner Content */
  .banner__content {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px 20px;
  }

  .banner__text {
    text-align: center;
    max-width: 800px;
    color: #ffffff;
  }

  .banner__heading {
    font-size: clamp(32px, 5vw, 64px);
    font-weight: 700;
    line-height: 1.2;
    margin: 0 0 20px;
    color: inherit;
  }

  .banner__subheading {
    font-size: clamp(16px, 2vw, 24px);
    line-height: 1.5;
    margin: 0 0 30px;
    color: inherit;
    opacity: 0.9;
  }

  .banner__button {
    display: inline-block;
    padding: 14px 32px;
    background: #ffffff;
    color: #000000;
    text-decoration: none;
    border-radius: 4px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .banner__button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  @media screen and (max-width: 767px) {
    .banner__content {
      padding: 20px;
    }

    .banner__text {
      max-width: 100%;
    }
  }
</style>

<script>
  (function() {
    let ticking = false;

    function updateScrollPosition() {
      const scrollY = window.pageYOffset;
      const rows = document.querySelectorAll('#{{ section.id }} .scrolled-images__row');
      
      rows.forEach((row, index) => {
        const speed = (index + 1) * 0.3;
        const direction = index === 1 ? 1 : -1;
        row.style.transform = `translateX(${direction * scrollY * speed}px)`;
      });
      
      ticking = false;
    }

    function requestTick() {
      if (!ticking) {
        window.requestAnimationFrame(updateScrollPosition);
        ticking = true;
      }
    }

    window.addEventListener('scroll', requestTick, { passive: true });
    updateScrollPosition();
  })();
</script>

{% schema %}
{
  "name": "Scrolled Images Banner",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Your Collection Title"
    },
    {
      "type": "richtext",
      "id": "subheading",
      "label": "Subheading",
      "default": "<p>Discover our amazing products</p>"
    },
    {
      "type": "text",
      "id": "show_view_all",
      "label": "Button Text",
      "default": "View All"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "header",
      "content": "Images"
    },
    {
      "type": "image_picker",
      "id": "image_1",
      "label": "Image 1"
    },
    {
      "type": "image_picker",
      "id": "image_2",
      "label": "Image 2"
    },
    {
      "type": "image_picker",
      "id": "image_3",
      "label": "Image 3"
    },
    {
      "type": "image_picker",
      "id": "image_4",
      "label": "Image 4"
    },
    {
      "type": "image_picker",
      "id": "image_5",
      "label": "Image 5"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "media_height",
      "label": "Banner Height",
      "default": "media--600px",
      "options": [
        { "value": "media--400px", "label": "400px" },
        { "value": "media--450px", "label": "450px" },
        { "value": "media--500px", "label": "500px" },
        { "value": "media--550px", "label": "550px" },
        { "value": "media--600px", "label": "600px" },
        { "value": "media--650px", "label": "650px" },
        { "value": "media--700px", "label": "700px" },
        { "value": "media--750px", "label": "750px" },
        { "value": "media--800px", "label": "800px" }
      ]
    },
    {
      "type": "checkbox",
      "id": "sw",
      "label": "Full Width",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "npd",
      "label": "Remove Side Padding",
      "default": true,
      "info": "Only applies when Full Width is enabled"
    },
    {
      "type": "header",
      "content": "Typography"
    },
    {
      "type": "range",
      "id": "fs",
      "label": "Font Size (Desktop)",
      "default": 20,
      "min": 12,
      "max": 40,
      "step": 1,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "fsm",
      "label": "Font Size (Mobile)",
      "default": 16,
      "min": 12,
      "max": 24,
      "step": 1,
      "unit": "px"
    },
    {
      "type": "select",
      "id": "fw",
      "label": "Font Weight",
      "default": "400",
      "options": [
        { "value": "300", "label": "Light" },
        { "value": "400", "label": "Regular" },
        { "value": "500", "label": "Medium" },
        { "value": "600", "label": "Semi Bold" },
        { "value": "700", "label": "Bold" }
      ]
    },
    {
      "type": "color",
      "id": "cl",
      "label": "Text Color",
      "default": "#000000"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "sst",
      "label": "Top Spacing (Desktop)",
      "default": 60,
      "min": 0,
      "max": 120,
      "step": 10,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "ssb",
      "label": "Bottom Spacing (Desktop)",
      "default": 60,
      "min": 0,
      "max": 120,
      "step": 10,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "sstm",
      "label": "Top Spacing (Mobile)",
      "default": 30,
      "min": 0,
      "max": 80,
      "step": 10,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "ssbm",
      "label": "Bottom Spacing (Mobile)",
      "default": 30,
      "min": 0,
      "max": 80,
      "step": 10,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Effects"
    },
    {
      "type": "range",
      "id": "parallax_speed",
      "label": "Scroll Animation Speed",
      "min": 0,
      "max": 2,
      "step": 0.1,
      "default": 0.3,
      "info": "Higher values = faster animation"
    },
    {
      "type": "color",
      "id": "bg",
      "label": "Background Color"
    }
  ],
  "presets": [
    {
      "name": "Scrolled Images Banner"
    }
  ]
}
{% endschema %}